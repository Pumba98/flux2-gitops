---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tandoor-recipes
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  dependsOn:
    - name: ingress-nginx-external
      namespace: networking
    - name: longhorn
      namespace: longhorn-system
    - name: tandoor-recipes-postgresql
  values:
    controllers:
      main:
        containers:
          main:
            image:
              repository: ghcr.io/tandoorrecipes/recipes
              tag: 2.0.1@sha256:b95f7b3e3df000cd39a152be0ddff7139c6d7c5f59cd306f325da44c50a81d05
            env:
              SECRET_KEY: ${SECRET_TANDOOR_RECEIPES_DB_PASSWORD}
              TZ: Europe/Berlin
              DB_ENGINE: django.db.backends.postgresql
              POSTGRES_HOST: tandoor-recipes-postgresql
              POSTGRES_PORT: "5432"
              POSTGRES_DB: tandoor-receipes
              POSTGRES_USER: tandoor-receipes
              POSTGRES_PASSWORD: ${SECRET_TANDOOR_RECEIPES_DB_PASSWORD}
              ENABLE_SIGNUP: 0
              ENABLE_PDF_EXPORT: 1
              SOCIAL_PROVIDERS: allauth.socialaccount.providers.openid_connect
              SOCIALACCOUNT_PROVIDERS: |
                {
                  "openid_connect": {
                    "SCOPE": ["openid", "profile", "email"],
                    "OAUTH_PKCE_ENABLED": true,
                    "APPS": [
                      {
                        "provider_id": "authelia",
                        "name": "Authelia",
                        "client_id": "2HilffOuYvUuFZ6mBu0elHbv6KAQrwQsCCsAs5SaIIUq.ZyiwKb70upbQQmI7sXjBs~i60Tz",
                        "secret": "${SECRET_TANDOOR_RECEIPES_OAUTH_CLIENT_SECRET}",
                        "settings": {
                          "server_url": "https://auth.${SECRET_DOMAIN}",
                          "token_auth_method": "client_secret_basic"
                        }
                      }
                    ]
                  }
                }
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 5
    service:
      main:
        controller: main
        ports:
          main:
            port: 80
    ingress:
      main:
        className: nginx-external
        annotations:
          external-dns.alpha.kubernetes.io/target: "${SECRET_GATEWAY}"
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/auth-url: http://authelia.networking.svc.cluster.local/api/authz/auth-request
          nginx.ingress.kubernetes.io/auth-signin: https://auth.${SECRET_DOMAIN}
        hosts:
          - host: recipes.${SECRET_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: main
                  port: main
        tls:
          - secretName: tandoor-recipes-tls
            hosts:
              - recipes.${SECRET_DOMAIN}
    persistence:
      static:
        existingClaim: tandoor-recipes-static
        globalMounts:
        - path: /opt/recipes/staticfiles
          subPath: staticfiles
        - path: /opt/recipes/mediafiles
          subPath: mediafiles
