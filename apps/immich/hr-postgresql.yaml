---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich-postgresql
spec:
  interval: 5m
  chart:
    spec:
      chart: postgresql
      version: 16.7.12
      sourceRef:
        kind: HelmRepository
        name: bitnami-charts
        namespace: flux-system
      interval: 5m
  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
    - name: longhorn
      namespace: longhorn-system
  values:
    global: 
      security: 
        allowInsecureImages: true
    image:
      registry: ghcr.io
      repository: immich-app/postgres
      tag: 17-vectorchord0.4.2@sha256:1ab7d94013ef6bb3873065f254bb01fd849cc4f19246065412c416ecdd301e5d
    auth:
      username: immich
      password: "${SECRET_IMMICH_DB_PASSWORD}"
      database: immich
    primary:
      resourcesPreset: "small"
      persistence:
        enabled: true
        existingClaim: immich-postgresql-data
      podSecurityContext:
        fsGroup: 999
      containerSecurityContext:
        readOnlyRootFilesystem: false
      # Init Container for Major PostgreSQL Upgrades, not needed permanently
      initContainers:
      - name: pgautoupgrade
        image: pgautoupgrade/pgautoupgrade:17-debian
        securityContext:
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
        - name: data
          mountPath: /bitnami/postgresql
        env:
          - name: PGAUTO_ONESHOT
            value: "yes"
          - name: PGDATA
            value: /bitnami/postgresql/data
          - name: POSTGRES_PASSWORD
            value: password
          - name: POSTGRES_DB
            value: immich
    metrics:
      enabled: false
      serviceMonitor:
        enabled: true
